class h{#s=!0;#e;#t;#a;#i;#h;#n;#r;#u=0;#c=5;#o=!1;#g=()=>{this.debugLog("Connected to event bus"),this.#h=!0,this.#o=!1,this.debugLog("Emitting queued events",this.#i),this.#i.forEach(t=>this.emitEventToBus(t)),this.#i=[],this.stopConnectLoop(),this.#t().removeEventListener("tanstack-connect-success",this.#g)};#d=()=>{if(this.#u<this.#c){this.#u++,this.dispatchCustomEvent("tanstack-connect",{});return}this.#t().removeEventListener("tanstack-connect",this.#d),this.debugLog("Max retries reached, giving up on connection"),this.stopConnectLoop()};#l=()=>{this.#o||(this.#o=!0,this.#t().addEventListener("tanstack-connect-success",this.#g),this.#d())};constructor({pluginId:t,debug:e=!1,enabled:n=!0,reconnectEveryMs:s=300}){this.#e=t,this.#s=n,this.#t=this.getGlobalTarget,this.#a=e,this.debugLog(" Initializing event subscription for plugin",this.#e),this.#i=[],this.#h=!1,this.#n=null,this.#r=s}startConnectLoop(){this.#n!==null||this.#h||(this.debugLog(`Starting connect loop (every ${this.#r}ms)`),this.#n=setInterval(this.#d,this.#r))}stopConnectLoop(){this.#o=!1,this.#n!==null&&(clearInterval(this.#n),this.#n=null,this.debugLog("Stopped connect loop"))}debugLog(...t){this.#a&&console.log(`ðŸŒ´ [tanstack-devtools:${this.#e}-plugin]`,...t)}getGlobalTarget(){if(typeof globalThis<"u"&&globalThis.__TANSTACK_EVENT_TARGET__)return this.debugLog("Using global event target"),globalThis.__TANSTACK_EVENT_TARGET__;if(typeof window<"u"&&typeof window.addEventListener<"u")return this.debugLog("Using window as event target"),window;const t=typeof EventTarget<"u"?new EventTarget:void 0;return typeof t>"u"||typeof t.addEventListener>"u"?(this.debugLog("No event mechanism available, running in non-web environment"),{addEventListener:()=>{},removeEventListener:()=>{},dispatchEvent:()=>!1}):(this.debugLog("Using new EventTarget as fallback"),t)}getPluginId(){return this.#e}dispatchCustomEventShim(t,e){try{const n=new Event(t,{detail:e});this.#t().dispatchEvent(n)}catch{this.debugLog("Failed to dispatch shim event")}}dispatchCustomEvent(t,e){try{this.#t().dispatchEvent(new CustomEvent(t,{detail:e}))}catch{this.dispatchCustomEventShim(t,e)}}emitEventToBus(t){this.debugLog("Emitting event to client bus",t),this.dispatchCustomEvent("tanstack-dispatch-event",t)}emit(t,e){if(!this.#s){this.debugLog("Event bus client is disabled, not emitting event",t,e);return}if(!this.#h){this.debugLog("Bus not available, will be pushed as soon as connected"),this.#i.push({type:`${this.#e}:${t}`,payload:e,pluginId:this.#e}),typeof CustomEvent<"u"&&!this.#o&&(this.#l(),this.startConnectLoop());return}return this.emitEventToBus({type:`${this.#e}:${t}`,payload:e,pluginId:this.#e})}on(t,e){const n=`${this.#e}:${t}`;if(!this.#s)return this.debugLog("Event bus client is disabled, not registering event",n),()=>{};const s=i=>{this.debugLog("Received event from bus",i.detail),e(i.detail)};return this.#t().addEventListener(n,s),this.debugLog("Registered event to bus",n),()=>{this.#t().removeEventListener(n,s)}}onAll(t){if(!this.#s)return this.debugLog("Event bus client is disabled, not registering event"),()=>{};const e=n=>{const s=n.detail;t(s)};return this.#t().addEventListener("tanstack-devtools-global",e),()=>this.#t().removeEventListener("tanstack-devtools-global",e)}onAllPluginEvents(t){if(!this.#s)return this.debugLog("Event bus client is disabled, not registering event"),()=>{};const e=n=>{const s=n.detail;this.#e&&s.pluginId!==this.#e||t(s)};return this.#t().addEventListener("tanstack-devtools-global",e),()=>this.#t().removeEventListener("tanstack-devtools-global",e)}}export{h as E};
